# TO-DO LIST PER IL PROGETTO DI GESTIONE PAGAMENTI

## ⚡ STATO ATTUALE DEL PROGETTO
**Ultima modifica:** 2025-10-09

### Sistema Operativo
- ✅ 90 pagamenti importati da Telegram
- ✅ 20 studenti identificati
- ✅ Bot Telegram attivo per associazioni interattive
- ✅ Google Calendar integrato (calendario "Lezioni Russo")
- ✅ Sistema skip/suspended per evitare loop

### Prossimi Passi
- [ ] Testare workflow completo: /process → skip → /suspended
- [ ] Continuare a processare i 90 pagamenti tramite bot
- [ ] Implementare logica di associazione pagamenti-lezioni
- [ ] Aggiungere gestione pagamenti multipli/parziali

---

## Configurazione e Setup iniziale
- [x] Creare l'ambiente di sviluppo (Python venv in .cal)
- [x] Impostare un sistema di controllo versione (Git)
- [x] Configurare l'accesso all'API di Telegram Bot (token in .env)
- [x] Configurare l'accesso a Google Calendar tramite Service Account
- [x] Creare Service Account su Google Cloud Console
- [x] Condividere calendario "Lezioni Russo" con service account
- [x] Testare accesso e lettura eventi (gcal_connect_test.py)
- [x] Progettare e creare lo schema del database

## Implementazione Database
- [x] Scegliere il database (SQLite)
- [x] Creare tabella 'pagamenti'
- [x] Creare tabella 'lezioni'
- [x] Creare tabella 'associazioni'
- [x] Creare tabella 'pagamenti_lezioni'
- [x] Configurare indici appropriati
- [x] Creare script di inizializzazione/migrazione DB (db_create_schema.py)
- [x] Aggiungere colonna 'skipped' a tabella pagamenti (per gestire loop)

## Sviluppo componente 1: Ingestore Pagamenti (telegram_ingestor.py)
- [x] Implementare connessione API Telegram (Telethon User API)
- [x] Configurare autenticazione Telegram (API_ID, API_HASH, phone, password)
- [x] Sviluppare logica di parsing dei messaggi da Telegram (regex per SMS banca russa)
- [x] Implementare meccanismo di estrazione dati (nome_pagante, giorno, ora, somma)
- [x] Creare sistema di deduplicazione basato su message ID (fonte_msg_id unique)
- [x] Implementare inserimento/aggiornamento nel DB con stato='sospeso'
- [x] Creare whitelist mittenti validi (mittenti_whitelist.csv)
- [x] Implementare filtro per escludere pagamenti da non-studenti
- [x] Gestire parsing importi con spazi (es. "10 000")
- [x] Aggiungere logging su console
- [ ] Aggiungere logging su file
- [ ] Creare unit test

## Sviluppo componente 2: Sincronizzatore Lezioni (gcal_connect_test.py)
- [x] Implementare connessione a Google Calendar per leggere il calendario "Lezioni Russo"
- [x] Testare lettura eventi con date e orari
- [ ] Sviluppare logica per estrarre nome_studente e dettagli lezione
- [ ] Implementare inserimento/aggiornamento lezioni nel DB
- [ ] Creare sistema di deduplicazione basato su event_id
- [ ] Gestire eventi ricorrenti vs singoli
- [ ] Aggiungere logging appropriato
- [ ] Creare unit test

## Sviluppo componente 3: Risolutore di Associazioni (association_resolver.py)
- [x] Implementare sistema di ricerca nelle associazioni esistenti
- [x] Sviluppare logica per recuperare lezioni ±3 giorni dalla data pagamento
- [x] Creare meccanismo per generare scelte multiple su Telegram (inline keyboard)
- [x] Implementare callback handler per le selezioni utente
- [x] Sviluppare logica per salvare associazioni studente-pagante
- [x] Implementare riuso automatico delle associazioni esistenti
- [x] Implementare processing sequenziale (un pagamento alla volta)
- [x] Implementare auto-avanzamento al prossimo pagamento dopo azione utente
- [x] Creare sistema skip/suspended per evitare loop
- [x] Implementare comando /process per pagamenti non-skipped
- [x] Implementare comando /suspended per pagamenti skipped
- [x] Aggiungere logging su file (bot.log)
- [x] Creare utility fuzzy matching (utils/name_matcher.py - attualmente non usato)
- [ ] Gestire validità temporale delle associazioni (valid_from, valid_to)
- [ ] Creare unit test

## Sviluppo componente 4: Associatore Pagamenti-Lezioni
- [ ] Sviluppare logica per verificare associazioni e pagamenti disponibili
- [ ] Implementare matching pagamenti con lezioni svolte
- [ ] Creare sistema per gestire pagamenti parziali/multipli
- [ ] Gestire pagamenti consumati/residui
- [ ] Implementare aggiornamento stato lezioni (prevista -> svolta -> pagata)
- [ ] Implementare aggiornamento stato pagamenti (sospeso -> associato -> usato)
- [ ] Implementare gestione degli errori e mismatch
- [ ] Sviluppare meccanismo di notifica su Telegram
- [ ] Aggiungere logging appropriato
- [ ] Creare unit test

## Struttura del Progetto
- [ ] Organizzare il codice in moduli/package appropriati
- [ ] Creare file di requirements.txt con le dipendenze
- [ ] Impostare struttura di configurazione (config.py)
- [ ] Creare script principali per ciascun componente

## Pianificazione ed Orchestrazione
- [ ] Configurare scheduler per eseguire i componenti in sequenza
- [ ] Impostare orari corretti (8:00, 8:02, 8:05 MSK)
- [ ] Gestire configurazione del fuso orario
- [ ] Implementare controlli di dipendenza tra componenti

## Documentazione
- [ ] Documentare API e interfacce
- [ ] Creare documentazione per l'utente
- [ ] Documentare procedure di backup/ripristino
- [ ] Creare diagrammi di flusso aggiornati

## Testing e QA
- [ ] Creare test di integrazione
- [ ] Implementare test di sistema end-to-end
- [ ] Testare scenari di errore e recovery
- [ ] Verificare performance sotto carico

## Monitoring e Manutenzione
- [ ] Implementare dashboard di monitoraggio
- [ ] Configurare sistema di allarmi
- [ ] Creare meccanismo di backup automatico
- [ ] Implementare strumenti di manutenzione DB

## Deployment
- [ ] Preparare ambiente di produzione
- [ ] Configurare deployment automatizzato
- [ ] Implementare strategia di rollback
- [ ] Eseguire migrazione iniziale dati (se necessario)

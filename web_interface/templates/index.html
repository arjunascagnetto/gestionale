<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Storico Pagamenti</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Stile default: bordo verde, sfondo bianco */
        .lesson-item { @apply border-l-4 border-green-500 bg-white; }
        .payment-item { @apply border-l-4 border-green-500 bg-white; }

        /* Stile quando gi√† abbinato: bordo grigio scuro, sfondo grigio chiaro */
        .lesson-item.abbinato { @apply border-gray-600 bg-gray-200; }
        .payment-item.abbinato { @apply border-blue-600 bg-blue-100; }

        /* Stile quando completamente usato (residuo = 0) */
        .payment-item.completamente-usato { @apply border-gray-600 bg-gray-200 opacity-75; }

        /* Stile quando selezionato (checkbox): bordo blu, sfondo blu chiaro */
        .lesson-item.selected { @apply border-blue-500 bg-blue-50; }
        .payment-item.selected { @apply border-blue-500 bg-blue-50; }

        /* Abbinamenti completati */
        .abbinamento-item { @apply border-l-4 border-gray-400 bg-gray-100; }

        /* Suggerimenti */
        .suggestion-item { @apply border-l-4 border-yellow-400 bg-yellow-50; }

        /* Hover */
        .lesson-item:hover, .payment-item:hover {
            @apply opacity-80;
        }

        /* Loading overlay */
        #loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
        }

        #loading-overlay.show {
            display: flex;
        }
    </style>
</head>
<body class="bg-gray-50 p-6">
    <div class="max-w-7xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold">üìä Gestione Storico Pagamenti e Lezioni</h1>
            <div class="flex gap-3">
                <a href="/normalizza" class="px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600">
                    üîß Normalizza
                </a>
                <a href="/rifiutati" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                    üö´ Rifiutati
                </a>
                <a href="/stats" class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600">
                    üìà Statistiche
                </a>
            </div>
        </div>

        <!-- Grid 2 colonne -->
        <div class="grid grid-cols-2 gap-6 mb-6">
            <!-- LEZIONI (Sinistra) -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">üìö LEZIONI NON PAGATE</h2>
                    <div class="flex gap-2">
                        <a href="?lesson_order=ASC&payment_order={{ payment_order }}"
                           class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">
                            ‚Üë Data
                        </a>
                        <a href="?lesson_order=DESC&payment_order={{ payment_order }}"
                           class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">
                            ‚Üì Data
                        </a>
                    </div>
                </div>

                <!-- Filtro Studenti -->
                <div class="mb-4 p-3 bg-gray-50 rounded border border-gray-200">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-sm">üîç Filtra per Studente</h3>
                        <button onclick="toggleStudentFilter()"
                                class="text-xs text-blue-600 hover:text-blue-800">
                            <span id="student-filter-toggle">‚ñº Mostra</span>
                        </button>
                    </div>
                    <div id="student-filter-list" class="hidden max-h-40 overflow-y-auto space-y-1">
                        {% for studente in all_studenti %}
                        <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-100 px-2 py-1 rounded">
                            <input type="checkbox"
                                   class="student-filter-checkbox"
                                   value="{{ studente }}"
                                   {% if studente in filter_studenti %}checked{% endif %}>
                            <span>{{ studente }}</span>
                        </label>
                        {% endfor %}
                    </div>
                    <div class="mt-2 flex gap-2">
                        <button onclick="applyFilters()"
                                class="flex-1 px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600">
                            ‚úì Applica Filtri
                        </button>
                        <button onclick="clearStudentFilters()"
                                class="px-3 py-1 bg-gray-300 text-gray-700 text-sm rounded hover:bg-gray-400">
                            ‚úó Reset
                        </button>
                    </div>
                </div>

                <div class="space-y-2 max-h-96 overflow-y-auto" id="lessons-list">
                    {% for lesson in lessons %}
                    <div class="lesson-item p-3 rounded {% if lesson.is_abbinata %}abbinato{% endif %} {% if lesson.gratis %}opacity-60{% endif %}" data-lesson-id="{{ lesson.id }}">
                        <label class="flex items-start cursor-pointer">
                            <input type="checkbox"
                                   name="lessons[]"
                                   value="{{ lesson.id }}"
                                   data-costo="{{ lesson.costo }}"
                                   class="mt-1 mr-3 w-5 h-5 lesson-checkbox"
                                   onchange="updateTotals()"
                                   {% if lesson.gratis %}disabled{% endif %}>
                            <div class="flex-1">
                                <div class="font-semibold flex items-center gap-2">
                                    {{ lesson.studente }}
                                    {% if lesson.gratis %}
                                    <span class="px-2 py-0.5 bg-purple-500 text-white text-xs rounded">üéÅ GRATIS</span>
                                    {% endif %}
                                </div>
                                <div class="text-sm text-gray-600">
                                    üìÖ {{ lesson.giorno }} ‚è∞ {{ lesson.ora }}
                                    {% if lesson.is_abbinata %}
                                    <span class="ml-2 px-2 py-0.5 bg-gray-600 text-white text-xs rounded">
                                        Abbinata ({{ lesson.quota_pagata }} RUB)
                                    </span>
                                    <button onclick="viewLessonAbbinamenti({{ lesson.id }}); event.stopPropagation();"
                                            class="ml-2 px-2 py-0.5 bg-orange-500 text-white text-xs rounded hover:bg-orange-600">
                                        üóëÔ∏è Elimina abbinamenti
                                    </button>
                                    {% endif %}
                                </div>
                                <div class="text-sm mt-1 flex items-center gap-2">
                                    <span class="text-gray-500">üíµ Costo:</span>
                                    <input type="number"
                                           class="costo-input w-24 px-2 py-1 border border-gray-300 rounded text-sm"
                                           value="{{ lesson.costo }}"
                                           min="0"
                                           step="100"
                                           data-lesson-id="{{ lesson.id }}"
                                           onchange="updateLessonCost(this, {{ lesson.id }})"
                                           onclick="event.stopPropagation()"
                                           {% if lesson.gratis %}disabled{% endif %}>
                                    <span class="text-gray-500">RUB</span>
                                    <span class="update-status-{{ lesson.id }} text-xs text-green-600 hidden">‚úì Salvato</span>
                                </div>
                                <div class="text-sm mt-2 flex items-center gap-2">
                                    <label class="flex items-center gap-1 cursor-pointer" onclick="event.stopPropagation()">
                                        <input type="checkbox"
                                               class="gratis-checkbox"
                                               {% if lesson.gratis %}checked{% endif %}
                                               onchange="toggleGratis(this, {{ lesson.id }})">
                                        <span class="text-xs text-purple-600 font-medium">Lezione di prova (gratis)</span>
                                    </label>
                                </div>
                            </div>
                        </label>
                    </div>
                    {% else %}
                    <p class="text-gray-500 text-center py-8">Nessuna lezione da pagare</p>
                    {% endfor %}
                </div>

                <div class="mt-4 p-3 bg-blue-50 rounded">
                    <div class="font-semibold">Selezionate: <span id="lessons-count">0</span></div>
                    <div class="text-sm text-gray-600">Totale debito: <span id="lessons-total">0</span> RUB</div>
                </div>
            </div>

            <!-- PAGAMENTI (Destra) -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">üí∞ PAGAMENTI DISPONIBILI</h2>
                    <div class="flex gap-2">
                        <a href="?lesson_order={{ lesson_order }}&payment_order=ASC"
                           class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">
                            ‚Üë Data
                        </a>
                        <a href="?lesson_order={{ lesson_order }}&payment_order=DESC"
                           class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">
                            ‚Üì Data
                        </a>
                    </div>
                </div>

                <!-- Filtro Paganti -->
                <div class="mb-4 p-3 bg-gray-50 rounded border border-gray-200">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-sm">üîç Filtra per Pagante</h3>
                        <button onclick="togglePaymentFilter()"
                                class="text-xs text-blue-600 hover:text-blue-800">
                            <span id="payment-filter-toggle">‚ñº Mostra</span>
                        </button>
                    </div>
                    <div id="payment-filter-list" class="hidden max-h-40 overflow-y-auto space-y-1">
                        {% for pagante in all_paganti %}
                        <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-100 px-2 py-1 rounded">
                            <input type="checkbox"
                                   class="payment-filter-checkbox"
                                   value="{{ pagante }}"
                                   {% if pagante in filter_paganti %}checked{% endif %}>
                            <span>{{ pagante }}</span>
                        </label>
                        {% endfor %}
                    </div>
                    <div class="mt-2 flex gap-2">
                        <button onclick="applyFilters()"
                                class="flex-1 px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600">
                            ‚úì Applica Filtri
                        </button>
                        <button onclick="clearPaymentFilters()"
                                class="px-3 py-1 bg-gray-300 text-gray-700 text-sm rounded hover:bg-gray-400">
                            ‚úó Reset
                        </button>
                    </div>
                </div>

                <div class="space-y-2 max-h-96 overflow-y-auto" id="payments-list">
                    {% for payment in payments %}
                    <div class="payment-item p-3 rounded {% if payment.is_completamente_usato %}completamente-usato{% elif payment.has_abbinamenti %}abbinato{% endif %}" id="payment-{{ payment.id }}">
                        <label class="flex items-start cursor-pointer">
                            <input type="checkbox"
                                   name="payments[]"
                                   value="{{ payment.id }}"
                                   data-residuo="{{ payment.residuo }}"
                                   class="mt-1 mr-3 w-5 h-5 payment-checkbox"
                                   onchange="updateTotals()"
                                   {% if payment.is_completamente_usato %}disabled{% endif %}>
                            <div class="flex-1">
                                <div class="font-semibold flex items-center gap-2">
                                    {{ payment.nome_pagante }}
                                    {% if payment.is_completamente_usato %}
                                    <span class="px-2 py-0.5 bg-gray-600 text-white text-xs rounded">‚úì COMPLETAMENTE USATO</span>
                                    {% endif %}
                                    {% if payment.has_abbinamenti %}
                                    <button onclick="togglePaymentDetails({{ payment.id }}); event.stopPropagation();"
                                            class="px-2 py-0.5 bg-purple-500 text-white text-xs rounded hover:bg-purple-600">
                                        üëÅÔ∏è Vedi abbinamenti
                                    </button>
                                    {% endif %}
                                </div>
                                <div class="text-sm text-gray-600">
                                    üíµ Residuo: {{ payment.residuo }} {{ payment.valuta }}
                                    <span class="text-xs">(di {{ payment.somma }} totali)</span>
                                    {% if payment.has_abbinamenti %}
                                    <span class="ml-2 px-2 py-0.5 bg-blue-600 text-white text-xs rounded">
                                        Usato: {{ payment.quota_utilizzata }} RUB
                                    </span>
                                    {% endif %}
                                </div>
                                <div class="text-xs text-gray-500">
                                    üìÖ {{ payment.giorno }} ‚è∞ {{ payment.ora }}
                                </div>
                                <!-- Dettagli abbinamenti (nascosti di default) -->
                                <div id="payment-details-{{ payment.id }}" class="hidden mt-2 p-2 bg-purple-50 rounded border border-purple-200">
                                    <div class="text-xs font-semibold text-purple-700 mb-1">Abbinato a:</div>
                                    <div id="payment-details-content-{{ payment.id }}" class="text-xs text-gray-700">
                                        <div class="animate-pulse">Caricamento...</div>
                                    </div>
                                </div>
                            </div>
                        </label>
                    </div>
                    {% else %}
                    <p class="text-gray-500 text-center py-8">Nessun pagamento disponibile</p>
                    {% endfor %}
                </div>

                <div class="mt-4 p-3 bg-green-50 rounded">
                    <div class="font-semibold">Selezionati: <span id="payments-count">0</span></div>
                    <div class="text-sm text-gray-600">Totale credito: <span id="payments-total">0</span> RUB</div>
                </div>
            </div>
        </div>

        <!-- Conferma Abbinamento -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex items-center justify-center">
                <form action="/abbina" method="POST" id="abbina-form" onsubmit="return validateAndSubmit(event)">
                    <!-- Hidden inputs per lezioni selezionate -->
                    <div id="hidden-lessons"></div>
                    <!-- Hidden inputs per pagamenti selezionati -->
                    <div id="hidden-payments"></div>

                    <button type="submit"
                            id="confirm-btn"
                            class="px-8 py-4 bg-blue-600 text-white rounded-lg font-bold text-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                            disabled>
                        üîó CONFERMA ABBINAMENTO
                    </button>
                </form>
            </div>
            <div id="error-msg" class="mt-2 text-red-600 text-sm text-center hidden"></div>
        </div>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="items-center justify-center">
            <div class="bg-white rounded-lg p-8 shadow-2xl text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto mb-4"></div>
                <p class="text-xl font-bold text-gray-700">Processing...</p>
                <p class="text-sm text-gray-500 mt-2">Creazione abbinamenti in corso</p>
            </div>
        </div>

        <!-- Suggerimenti Intelligenti -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold mb-2">üí° SUGGERIMENTI AUTOMATICI</h2>
            <p class="text-sm text-gray-600 mb-4">Basati sulle associazioni studente-pagante esistenti e vicinanza temporale (¬±7 giorni)</p>

            {% if suggestions %}
            <div class="space-y-3" id="suggestions-container">
                {% for sug in suggestions %}
                <div class="suggestion-item p-4 rounded flex justify-between items-center"
                     id="suggestion-{{ sug.lezione_id }}-{{ sug.pagamento_id }}">
                    <div class="flex-1 grid grid-cols-3 gap-4">
                        <div>
                            <div class="font-semibold text-blue-700">üìö Lezione</div>
                            <div class="text-sm font-medium">{{ sug.studente }}</div>
                            <div class="text-xs text-gray-600">üìÖ {{ sug.lez_giorno }} ‚è∞ {{ sug.lez_ora }}</div>
                            <div class="text-xs mt-1 flex items-center gap-1">
                                <span class="text-gray-500">Costo:</span>
                                <input type="number"
                                       class="costo-suggestion-input w-20 px-1 py-0.5 border border-gray-300 rounded text-xs"
                                       value="{{ sug.costo }}"
                                       min="0"
                                       step="100"
                                       data-lesson-id="{{ sug.lezione_id }}"
                                       data-payment-id="{{ sug.pagamento_id }}"
                                       onchange="updateSuggestionCost(this, {{ sug.lezione_id }}, {{ sug.pagamento_id }}, {{ sug.gia_pagato }})"
                                       onclick="event.stopPropagation()">
                                <span class="text-gray-500">RUB</span>
                                <span class="update-sug-status-{{ sug.lezione_id }}-{{ sug.pagamento_id }} text-xs text-green-600 hidden">‚úì</span>
                                {% if sug.gia_pagato > 0 %}
                                <span class="text-orange-600">(gi√†: {{ sug.gia_pagato }})</span>
                                {% endif %}
                            </div>
                        </div>
                        <div>
                            <div class="font-semibold text-green-700">üí∞ Pagamento</div>
                            <div class="text-sm font-medium">{{ sug.pagante }}</div>
                            <div class="text-xs text-gray-600">üìÖ {{ sug.pag_giorno }} ‚è∞ {{ sug.pag_ora }}</div>
                            <div class="text-xs mt-1">
                                <span class="text-gray-500">Residuo:</span> {{ sug.residuo }} {{ sug.valuta }}
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-gray-500 mb-1">Distanza temporale</div>
                            <div class="text-2xl font-bold text-purple-600">{{ sug.giorni_distanza }}</div>
                            <div class="text-xs text-gray-500">giorni</div>
                            <div class="mt-2 px-2 py-1 bg-green-100 text-green-800 text-xs rounded font-semibold"
                                 id="quota-display-{{ sug.lezione_id }}-{{ sug.pagamento_id }}"
                                 data-quota="{{ sug.quota_suggerita }}">
                                Quota: <span class="quota-value">{{ sug.quota_suggerita }}</span> RUB
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2 ml-4">
                        <button onclick="confirmSuggestionWithCurrentQuota({{ sug.lezione_id }}, {{ sug.pagamento_id }})"
                                class="confirm-btn-{{ sug.lezione_id }}-{{ sug.pagamento_id }} px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 font-semibold">
                            ‚úì Conferma
                        </button>
                        <button onclick="rejectSuggestion({{ sug.lezione_id }}, {{ sug.pagamento_id }})"
                                class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 font-semibold">
                            ‚úó Rifiuta
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-gray-500 text-center py-8">Nessun suggerimento disponibile al momento</p>
            {% endif %}
        </div>

        <!-- Abbinamenti Esistenti -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4">üìä ABBINAMENTI COMPLETATI</h2>

            {% if abbinamenti %}
            <div class="space-y-2">
                {% for abb in abbinamenti %}
                <div class="abbinamento-item p-3 rounded flex justify-between items-center">
                    <div class="flex-1 grid grid-cols-2 gap-4">
                        <div>
                            <div class="font-semibold">Lezione:</div>
                            <div class="text-sm">{{ abb.lezione }}</div>
                        </div>
                        <div>
                            <div class="font-semibold">Pagamento:</div>
                            <div class="text-sm">{{ abb.pagamento }} ‚Üí {{ abb.quota }} {{ abb.valuta }}</div>
                        </div>
                    </div>
                    <form action="/delete/{{ abb.id }}" method="POST"
                          onsubmit="return confirm('Eliminare questo abbinamento?')">
                        <button type="submit"
                                class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600">
                            üóëÔ∏è Elimina
                        </button>
                    </form>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-gray-500 text-center py-8">Nessun abbinamento esistente</p>
            {% endif %}
        </div>
    </div>

    <script>
        function toggleGratis(checkbox, lessonId) {
            const isGratis = checkbox.checked;

            if (!confirm(isGratis ?
                'Segnare questa lezione come GRATIS (lezione di prova)? Non sar√† pi√π abbinabile a pagamenti.' :
                'Rimuovere il flag GRATIS da questa lezione? Torner√† abbinabile ai pagamenti.')) {
                checkbox.checked = !isGratis;
                return;
            }

            fetch(`/toggle_gratis/${lessonId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ gratis: isGratis })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Ricarica la pagina per aggiornare l'interfaccia
                    window.location.reload();
                } else {
                    alert('Errore durante l\'aggiornamento: ' + data.error);
                    checkbox.checked = !isGratis;
                }
            })
            .catch(error => {
                console.error('Errore:', error);
                alert('Errore di connessione');
                checkbox.checked = !isGratis;
            });
        }

        function updateLessonCost(input, lessonId) {
            const newCost = parseFloat(input.value);

            if (isNaN(newCost) || newCost < 0) {
                alert('Inserisci un costo valido!');
                return;
            }

            // Aggiorna data-costo del checkbox corrispondente
            const checkbox = document.querySelector(`.lesson-checkbox[value="${lessonId}"]`);
            if (checkbox) {
                checkbox.dataset.costo = newCost;
            }

            // Invia aggiornamento al server
            fetch(`/update_cost/${lessonId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ costo: newCost })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mostra feedback visivo
                    const statusSpan = document.querySelector(`.update-status-${lessonId}`);
                    if (statusSpan) {
                        statusSpan.classList.remove('hidden');
                        setTimeout(() => {
                            statusSpan.classList.add('hidden');
                        }, 2000);
                    }
                    // Ricalcola totali se la lezione √® selezionata
                    updateTotals();
                } else {
                    alert('Errore durante l\'aggiornamento: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Errore:', error);
                alert('Errore di connessione');
            });
        }

        function updateTotals() {
            // Conta lezioni selezionate e somma i costi individuali
            const lessonCheckboxes = document.querySelectorAll('.lesson-checkbox:checked');
            const lessonCount = lessonCheckboxes.length;
            let lessonTotal = 0;

            lessonCheckboxes.forEach(cb => {
                const costo = parseFloat(cb.dataset.costo) || 2000;
                lessonTotal += costo;
            });

            // Conta pagamenti selezionati e somma residuo
            const paymentCheckboxes = document.querySelectorAll('.payment-checkbox:checked');
            const paymentCount = paymentCheckboxes.length;
            let paymentTotal = 0;

            paymentCheckboxes.forEach(cb => {
                paymentTotal += parseFloat(cb.dataset.residuo);
            });

            // Aggiorna UI
            document.getElementById('lessons-count').textContent = lessonCount;
            document.getElementById('lessons-total').textContent = lessonTotal;
            document.getElementById('payments-count').textContent = paymentCount;
            document.getElementById('payments-total').textContent = paymentTotal;

            // Abilita/disabilita pulsante conferma
            const confirmBtn = document.getElementById('confirm-btn');
            const errorMsg = document.getElementById('error-msg');

            if (lessonCount === 0 || paymentCount === 0) {
                confirmBtn.disabled = true;
                errorMsg.textContent = '';
                errorMsg.classList.add('hidden');
            } else {
                confirmBtn.disabled = false;
                errorMsg.textContent = '';
                errorMsg.classList.add('hidden');
            }

            // Aggiorna stile visivo per elementi selezionati
            updateVisualStyles();

            // Aggiorna hidden inputs per il form
            updateHiddenInputs();
        }

        function updateVisualStyles() {
            // Aggiorna stile lezioni
            document.querySelectorAll('.lesson-checkbox').forEach(cb => {
                const lessonItem = cb.closest('.lesson-item');
                if (cb.checked) {
                    lessonItem.classList.add('selected');
                } else {
                    lessonItem.classList.remove('selected');
                }
            });

            // Aggiorna stile pagamenti
            document.querySelectorAll('.payment-checkbox').forEach(cb => {
                const paymentItem = cb.closest('.payment-item');
                if (cb.checked) {
                    paymentItem.classList.add('selected');
                } else {
                    paymentItem.classList.remove('selected');
                }
            });
        }

        function updateHiddenInputs() {
            // Lezioni
            const hiddenLessons = document.getElementById('hidden-lessons');
            hiddenLessons.innerHTML = '';
            document.querySelectorAll('.lesson-checkbox:checked').forEach(cb => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'lessons[]';
                input.value = cb.value;
                hiddenLessons.appendChild(input);
            });

            // Pagamenti
            const hiddenPayments = document.getElementById('hidden-payments');
            hiddenPayments.innerHTML = '';
            document.querySelectorAll('.payment-checkbox:checked').forEach(cb => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'payments[]';
                input.value = cb.value;
                hiddenPayments.appendChild(input);
            });
        }

        function validateAndSubmit(event) {
            const lessonCount = document.querySelectorAll('.lesson-checkbox:checked').length;
            const paymentCount = document.querySelectorAll('.payment-checkbox:checked').length;

            if (lessonCount === 0 || paymentCount === 0) {
                alert('Seleziona almeno una lezione e un pagamento!');
                event.preventDefault();
                return false;
            }

            if (!confirm(`Confermi abbinamento di ${lessonCount} lezioni con ${paymentCount} pagamenti?`)) {
                event.preventDefault();
                return false;
            }

            // Mostra loading overlay
            document.getElementById('loading-overlay').classList.add('show');

            return true;
        }

        function updateSuggestionCost(input, lezioneId, pagamentoId, giaPagato) {
            const newCost = parseFloat(input.value);

            if (isNaN(newCost) || newCost < 0) {
                alert('Inserisci un costo valido!');
                return;
            }

            // Invia aggiornamento al server
            fetch(`/update_cost/${lezioneId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ costo: newCost })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mostra feedback visivo
                    const statusSpan = document.querySelector(`.update-sug-status-${lezioneId}-${pagamentoId}`);
                    if (statusSpan) {
                        statusSpan.classList.remove('hidden');
                        setTimeout(() => {
                            statusSpan.classList.add('hidden');
                        }, 2000);
                    }

                    // Ricalcola la quota suggerita
                    const nuovaQuota = Math.max(0, newCost - giaPagato);
                    const quotaDisplay = document.getElementById(`quota-display-${lezioneId}-${pagamentoId}`);
                    if (quotaDisplay) {
                        quotaDisplay.dataset.quota = nuovaQuota;
                        const quotaValue = quotaDisplay.querySelector('.quota-value');
                        if (quotaValue) {
                            quotaValue.textContent = nuovaQuota;
                        }
                    }
                } else {
                    alert('Errore durante l\'aggiornamento: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Errore:', error);
                alert('Errore di connessione');
            });
        }

        function confirmSuggestionWithCurrentQuota(lezioneId, pagamentoId) {
            // Leggi la quota attuale dal DOM (potrebbe essere stata modificata)
            const quotaDisplay = document.getElementById(`quota-display-${lezioneId}-${pagamentoId}`);
            const quota = quotaDisplay ? parseFloat(quotaDisplay.dataset.quota) : 0;

            confirmSuggestion(lezioneId, pagamentoId, quota);
        }

        function confirmSuggestion(lezioneId, pagamentoId, quota) {
            if (!confirm(`Confermare abbinamento di ${quota} RUB?`)) {
                return;
            }

            // Mostra loading
            document.getElementById('loading-overlay').classList.add('show');

            fetch('/confirm_suggestion', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    lezione_id: lezioneId,
                    pagamento_id: pagamentoId,
                    quota: quota
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loading-overlay').classList.remove('show');

                if (data.success) {
                    // Rimuovi il suggerimento dalla UI
                    const suggestionDiv = document.getElementById(`suggestion-${lezioneId}-${pagamentoId}`);
                    if (suggestionDiv) {
                        suggestionDiv.style.transition = 'opacity 0.3s';
                        suggestionDiv.style.opacity = '0';
                        setTimeout(() => {
                            suggestionDiv.remove();

                            // Se non ci sono pi√π suggerimenti, mostra messaggio
                            const container = document.getElementById('suggestions-container');
                            if (container && container.children.length === 0) {
                                container.innerHTML = '<p class="text-gray-500 text-center py-8">Nessun suggerimento disponibile al momento</p>';
                            }
                        }, 300);
                    }

                    // Ricarica la pagina dopo 1 secondo per aggiornare tutte le liste
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    alert('Errore durante la conferma: ' + (data.error || 'Errore sconosciuto'));
                }
            })
            .catch(error => {
                document.getElementById('loading-overlay').classList.remove('show');
                console.error('Errore:', error);
                alert('Errore di connessione');
            });
        }

        function rejectSuggestion(lezioneId, pagamentoId) {
            if (!confirm('Rifiutare questo suggerimento? La lezione e il pagamento resteranno disponibili per abbinamenti manuali.')) {
                return;
            }

            fetch('/reject_suggestion', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    lezione_id: lezioneId,
                    pagamento_id: pagamentoId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Rimuovi il suggerimento dalla UI
                    const suggestionDiv = document.getElementById(`suggestion-${lezioneId}-${pagamentoId}`);
                    if (suggestionDiv) {
                        suggestionDiv.style.transition = 'opacity 0.3s';
                        suggestionDiv.style.opacity = '0';
                        setTimeout(() => {
                            suggestionDiv.remove();

                            // Se non ci sono pi√π suggerimenti, mostra messaggio
                            const container = document.getElementById('suggestions-container');
                            if (container && container.children.length === 0) {
                                container.innerHTML = '<p class="text-gray-500 text-center py-8">Nessun suggerimento disponibile al momento</p>';
                            }
                        }, 300);
                    }
                } else {
                    alert('Errore durante il rifiuto: ' + (data.error || 'Errore sconosciuto'));
                }
            })
            .catch(error => {
                console.error('Errore:', error);
                alert('Errore di connessione');
            });
        }

        // ===== ELIMINA ABBINAMENTI LEZIONE =====

        function viewLessonAbbinamenti(lessonId) {
            // Fetch abbinamenti della lezione via API
            fetch(`/get_lesson_abbinamenti/${lessonId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.abbinamenti && data.abbinamenti.length > 0) {
                        let message = `Questa lezione ha ${data.abbinamenti.length} abbinamenti:\n\n`;
                        data.abbinamenti.forEach((abb, idx) => {
                            message += `${idx + 1}. ${abb.nome_pagante} - ${abb.giorno} ${abb.ora}: ${abb.quota} RUB\n`;
                        });
                        message += `\nEliminare TUTTI gli abbinamenti di questa lezione?`;

                        if (confirm(message)) {
                            deleteLessonAbbinamenti(lessonId);
                        }
                    } else {
                        alert('Nessun abbinamento trovato per questa lezione.');
                    }
                })
                .catch(error => {
                    console.error('Errore:', error);
                    alert('Errore nel recuperare gli abbinamenti');
                });
        }

        function deleteLessonAbbinamenti(lessonId) {
            // Mostra loading
            document.getElementById('loading-overlay').classList.add('show');

            fetch(`/delete_lesson_abbinamenti/${lessonId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loading-overlay').classList.remove('show');

                if (data.success) {
                    alert(`Eliminati ${data.deleted_count} abbinamenti`);
                    window.location.reload();
                } else {
                    alert('Errore durante l\'eliminazione: ' + (data.error || 'Errore sconosciuto'));
                }
            })
            .catch(error => {
                document.getElementById('loading-overlay').classList.remove('show');
                console.error('Errore:', error);
                alert('Errore di connessione');
            });
        }

        // ===== DETTAGLI PAGAMENTO =====

        function togglePaymentDetails(paymentId) {
            const detailsDiv = document.getElementById(`payment-details-${paymentId}`);
            const contentDiv = document.getElementById(`payment-details-content-${paymentId}`);

            if (detailsDiv.classList.contains('hidden')) {
                // Mostra e carica dettagli
                detailsDiv.classList.remove('hidden');

                // Fetch abbinamenti via API
                fetch(`/get_payment_details/${paymentId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.abbinamenti && data.abbinamenti.length > 0) {
                            let html = '<div class="space-y-1">';
                            data.abbinamenti.forEach(abb => {
                                html += `<div class="flex justify-between items-center">
                                    <span>üìö ${abb.studente} - ${abb.giorno} ${abb.ora}</span>
                                    <span class="font-semibold">${abb.quota} RUB</span>
                                </div>`;
                            });
                            html += '</div>';
                            contentDiv.innerHTML = html;
                        } else {
                            contentDiv.innerHTML = '<div class="text-gray-500">Nessun abbinamento</div>';
                        }
                    })
                    .catch(error => {
                        console.error('Errore:', error);
                        contentDiv.innerHTML = '<div class="text-red-500">Errore caricamento</div>';
                    });
            } else {
                // Nascondi
                detailsDiv.classList.add('hidden');
            }
        }

        // ===== FILTRI =====

        function toggleStudentFilter() {
            const filterList = document.getElementById('student-filter-list');
            const toggleText = document.getElementById('student-filter-toggle');

            if (filterList.classList.contains('hidden')) {
                filterList.classList.remove('hidden');
                toggleText.textContent = '‚ñ≤ Nascondi';
            } else {
                filterList.classList.add('hidden');
                toggleText.textContent = '‚ñº Mostra';
            }
        }

        function togglePaymentFilter() {
            const filterList = document.getElementById('payment-filter-list');
            const toggleText = document.getElementById('payment-filter-toggle');

            if (filterList.classList.contains('hidden')) {
                filterList.classList.remove('hidden');
                toggleText.textContent = '‚ñ≤ Nascondi';
            } else {
                filterList.classList.add('hidden');
                toggleText.textContent = '‚ñº Mostra';
            }
        }

        function applyFilters() {
            // Ottieni studenti selezionati
            const studentCheckboxes = document.querySelectorAll('.student-filter-checkbox:checked');
            const selectedStudents = Array.from(studentCheckboxes).map(cb => cb.value);

            // Ottieni paganti selezionati
            const paymentCheckboxes = document.querySelectorAll('.payment-filter-checkbox:checked');
            const selectedPaganti = Array.from(paymentCheckboxes).map(cb => cb.value);

            // Costruisci URL con parametri filtro
            const params = new URLSearchParams();

            // Mantieni parametri ordinamento
            params.set('lesson_order', '{{ lesson_order }}');
            params.set('payment_order', '{{ payment_order }}');

            // Aggiungi filtri studenti
            selectedStudents.forEach(studente => {
                params.append('studenti', studente);
            });

            // Aggiungi filtri paganti
            selectedPaganti.forEach(pagante => {
                params.append('paganti', pagante);
            });

            // Ricarica pagina con filtri
            window.location.href = '/?' + params.toString();
        }

        function clearStudentFilters() {
            // Deselezione tutti i checkbox studenti
            document.querySelectorAll('.student-filter-checkbox').forEach(cb => {
                cb.checked = false;
            });

            // Applica filtri (che saranno vuoti, quindi mostra tutto)
            applyFilters();
        }

        function clearPaymentFilters() {
            // Deselezione tutti i checkbox paganti
            document.querySelectorAll('.payment-filter-checkbox').forEach(cb => {
                cb.checked = false;
            });

            // Applica filtri (che saranno vuoti, quindi mostra tutto)
            applyFilters();
        }

        // Inizializza al caricamento
        updateTotals();

        // Auto-espandi filtri se sono attivi
        {% if filter_studenti|length > 0 %}
        toggleStudentFilter();
        {% endif %}

        {% if filter_paganti|length > 0 %}
        togglePaymentFilter();
        {% endif %}
    </script>
</body>
</html>

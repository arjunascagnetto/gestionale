<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Storico Pagamenti</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Stile default: bordo verde, sfondo bianco */
        .lesson-item { @apply border-l-4 border-green-500 bg-white; }
        .payment-item { @apply border-l-4 border-green-500 bg-white; }

        /* Stile quando gi√† abbinato: bordo grigio scuro, sfondo grigio chiaro */
        .lesson-item.abbinato { @apply border-gray-600 bg-gray-200; }
        .payment-item.abbinato { @apply border-blue-600 bg-blue-100; }

        /* Stile quando selezionato (checkbox): bordo blu, sfondo blu chiaro */
        .lesson-item.selected { @apply border-blue-500 bg-blue-50; }
        .payment-item.selected { @apply border-blue-500 bg-blue-50; }

        /* Abbinamenti completati */
        .abbinamento-item { @apply border-l-4 border-gray-400 bg-gray-100; }

        /* Hover */
        .lesson-item:hover, .payment-item:hover {
            @apply opacity-80;
        }

        /* Loading overlay */
        #loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
        }

        #loading-overlay.show {
            display: flex;
        }
    </style>
</head>
<body class="bg-gray-50 p-6">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-center">üìä Gestione Storico Pagamenti e Lezioni</h1>

        <!-- Grid 2 colonne -->
        <div class="grid grid-cols-2 gap-6 mb-6">
            <!-- LEZIONI (Sinistra) -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">üìö LEZIONI NON PAGATE</h2>
                    <div class="flex gap-2">
                        <a href="?lesson_order=ASC&payment_order={{ payment_order }}"
                           class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">
                            ‚Üë Data
                        </a>
                        <a href="?lesson_order=DESC&payment_order={{ payment_order }}"
                           class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">
                            ‚Üì Data
                        </a>
                    </div>
                </div>

                <div class="space-y-2 max-h-96 overflow-y-auto" id="lessons-list">
                    {% for lesson in lessons %}
                    <div class="lesson-item p-3 rounded {% if lesson.is_abbinata %}abbinato{% endif %}">
                        <label class="flex items-start cursor-pointer">
                            <input type="checkbox"
                                   name="lessons[]"
                                   value="{{ lesson.id }}"
                                   class="mt-1 mr-3 w-5 h-5 lesson-checkbox"
                                   onchange="updateTotals()">
                            <div class="flex-1">
                                <div class="font-semibold">{{ lesson.studente }}</div>
                                <div class="text-sm text-gray-600">
                                    üìÖ {{ lesson.giorno }} ‚è∞ {{ lesson.ora }}
                                    {% if lesson.is_abbinata %}
                                    <span class="ml-2 px-2 py-0.5 bg-gray-600 text-white text-xs rounded">
                                        Abbinata ({{ lesson.quota_pagata }} RUB)
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </label>
                    </div>
                    {% else %}
                    <p class="text-gray-500 text-center py-8">Nessuna lezione da pagare</p>
                    {% endfor %}
                </div>

                <div class="mt-4 p-3 bg-blue-50 rounded">
                    <div class="font-semibold">Selezionate: <span id="lessons-count">0</span></div>
                    <div class="text-sm text-gray-600">Totale debito: <span id="lessons-total">0</span> RUB</div>
                </div>
            </div>

            <!-- PAGAMENTI (Destra) -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">üí∞ PAGAMENTI DISPONIBILI</h2>
                    <div class="flex gap-2">
                        <a href="?lesson_order={{ lesson_order }}&payment_order=ASC"
                           class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">
                            ‚Üë Data
                        </a>
                        <a href="?lesson_order={{ lesson_order }}&payment_order=DESC"
                           class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">
                            ‚Üì Data
                        </a>
                    </div>
                </div>

                <div class="space-y-2 max-h-96 overflow-y-auto" id="payments-list">
                    {% for payment in payments %}
                    <div class="payment-item p-3 rounded {% if payment.has_abbinamenti %}abbinato{% endif %}">
                        <label class="flex items-start cursor-pointer">
                            <input type="checkbox"
                                   name="payments[]"
                                   value="{{ payment.id }}"
                                   data-residuo="{{ payment.residuo }}"
                                   class="mt-1 mr-3 w-5 h-5 payment-checkbox"
                                   onchange="updateTotals()">
                            <div class="flex-1">
                                <div class="font-semibold">{{ payment.nome_pagante }}</div>
                                <div class="text-sm text-gray-600">
                                    üíµ {{ payment.residuo }} {{ payment.valuta }}
                                    <span class="text-xs">(di {{ payment.somma }} totali)</span>
                                    {% if payment.has_abbinamenti %}
                                    <span class="ml-2 px-2 py-0.5 bg-blue-600 text-white text-xs rounded">
                                        Usato: {{ payment.quota_utilizzata }} RUB
                                    </span>
                                    {% endif %}
                                </div>
                                <div class="text-xs text-gray-500">
                                    üìÖ {{ payment.giorno }} ‚è∞ {{ payment.ora }}
                                </div>
                            </div>
                        </label>
                    </div>
                    {% else %}
                    <p class="text-gray-500 text-center py-8">Nessun pagamento disponibile</p>
                    {% endfor %}
                </div>

                <div class="mt-4 p-3 bg-green-50 rounded">
                    <div class="font-semibold">Selezionati: <span id="payments-count">0</span></div>
                    <div class="text-sm text-gray-600">Totale credito: <span id="payments-total">0</span> RUB</div>
                </div>
            </div>
        </div>

        <!-- Conferma Abbinamento -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex items-center justify-center">
                <form action="/abbina" method="POST" id="abbina-form" onsubmit="return validateAndSubmit(event)">
                    <!-- Hidden inputs per lezioni selezionate -->
                    <div id="hidden-lessons"></div>
                    <!-- Hidden inputs per pagamenti selezionati -->
                    <div id="hidden-payments"></div>

                    <button type="submit"
                            id="confirm-btn"
                            class="px-8 py-4 bg-blue-600 text-white rounded-lg font-bold text-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                            disabled>
                        üîó CONFERMA ABBINAMENTO
                    </button>
                </form>
            </div>
            <div id="error-msg" class="mt-2 text-red-600 text-sm text-center hidden"></div>
        </div>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="items-center justify-center">
            <div class="bg-white rounded-lg p-8 shadow-2xl text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto mb-4"></div>
                <p class="text-xl font-bold text-gray-700">Processing...</p>
                <p class="text-sm text-gray-500 mt-2">Creazione abbinamenti in corso</p>
            </div>
        </div>

        <!-- Abbinamenti Esistenti -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4">üìä ABBINAMENTI COMPLETATI</h2>

            {% if abbinamenti %}
            <div class="space-y-2">
                {% for abb in abbinamenti %}
                <div class="abbinamento-item p-3 rounded flex justify-between items-center">
                    <div class="flex-1 grid grid-cols-2 gap-4">
                        <div>
                            <div class="font-semibold">Lezione:</div>
                            <div class="text-sm">{{ abb.lezione }}</div>
                        </div>
                        <div>
                            <div class="font-semibold">Pagamento:</div>
                            <div class="text-sm">{{ abb.pagamento }} ‚Üí {{ abb.quota }} {{ abb.valuta }}</div>
                        </div>
                    </div>
                    <form action="/delete/{{ abb.id }}" method="POST"
                          onsubmit="return confirm('Eliminare questo abbinamento?')">
                        <button type="submit"
                                class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600">
                            üóëÔ∏è Elimina
                        </button>
                    </form>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-gray-500 text-center py-8">Nessun abbinamento esistente</p>
            {% endif %}
        </div>
    </div>

    <script>
        const COSTO_LEZIONE = 2000; // RUB per lezione (configurabile)

        function updateTotals() {
            // Conta lezioni selezionate
            const lessonCheckboxes = document.querySelectorAll('.lesson-checkbox:checked');
            const lessonCount = lessonCheckboxes.length;
            const lessonTotal = lessonCount * COSTO_LEZIONE;

            // Conta pagamenti selezionati e somma residuo
            const paymentCheckboxes = document.querySelectorAll('.payment-checkbox:checked');
            const paymentCount = paymentCheckboxes.length;
            let paymentTotal = 0;

            paymentCheckboxes.forEach(cb => {
                paymentTotal += parseFloat(cb.dataset.residuo);
            });

            // Aggiorna UI
            document.getElementById('lessons-count').textContent = lessonCount;
            document.getElementById('lessons-total').textContent = lessonTotal;
            document.getElementById('payments-count').textContent = paymentCount;
            document.getElementById('payments-total').textContent = paymentTotal;

            // Abilita/disabilita pulsante conferma
            const confirmBtn = document.getElementById('confirm-btn');
            const errorMsg = document.getElementById('error-msg');

            if (lessonCount === 0 || paymentCount === 0) {
                confirmBtn.disabled = true;
                errorMsg.textContent = '';
                errorMsg.classList.add('hidden');
            } else {
                confirmBtn.disabled = false;
                errorMsg.textContent = '';
                errorMsg.classList.add('hidden');
            }

            // Aggiorna stile visivo per elementi selezionati
            updateVisualStyles();

            // Aggiorna hidden inputs per il form
            updateHiddenInputs();
        }

        function updateVisualStyles() {
            // Aggiorna stile lezioni
            document.querySelectorAll('.lesson-checkbox').forEach(cb => {
                const lessonItem = cb.closest('.lesson-item');
                if (cb.checked) {
                    lessonItem.classList.add('selected');
                } else {
                    lessonItem.classList.remove('selected');
                }
            });

            // Aggiorna stile pagamenti
            document.querySelectorAll('.payment-checkbox').forEach(cb => {
                const paymentItem = cb.closest('.payment-item');
                if (cb.checked) {
                    paymentItem.classList.add('selected');
                } else {
                    paymentItem.classList.remove('selected');
                }
            });
        }

        function updateHiddenInputs() {
            // Lezioni
            const hiddenLessons = document.getElementById('hidden-lessons');
            hiddenLessons.innerHTML = '';
            document.querySelectorAll('.lesson-checkbox:checked').forEach(cb => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'lessons[]';
                input.value = cb.value;
                hiddenLessons.appendChild(input);
            });

            // Pagamenti
            const hiddenPayments = document.getElementById('hidden-payments');
            hiddenPayments.innerHTML = '';
            document.querySelectorAll('.payment-checkbox:checked').forEach(cb => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'payments[]';
                input.value = cb.value;
                hiddenPayments.appendChild(input);
            });
        }

        function validateAndSubmit(event) {
            const lessonCount = document.querySelectorAll('.lesson-checkbox:checked').length;
            const paymentCount = document.querySelectorAll('.payment-checkbox:checked').length;

            if (lessonCount === 0 || paymentCount === 0) {
                alert('Seleziona almeno una lezione e un pagamento!');
                event.preventDefault();
                return false;
            }

            if (!confirm(`Confermi abbinamento di ${lessonCount} lezioni con ${paymentCount} pagamenti?`)) {
                event.preventDefault();
                return false;
            }

            // Mostra loading overlay
            document.getElementById('loading-overlay').classList.add('show');

            return true;
        }

        // Inizializza al caricamento
        updateTotals();
    </script>
</body>
</html>

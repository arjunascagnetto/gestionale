<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Normalizzazione e Calendario</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-6">
    <div class="max-w-7xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold">üîß Normalizzazione e Google Calendar</h1>
            <a href="/" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                ‚Üê Home
            </a>
        </div>

        <!-- Sezione 1: Normalizzazione Nomi -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">üìù Normalizzazione Nomi Studenti</h2>
            <p class="text-sm text-gray-600 mb-4">
                Uniforme le varianti dei nomi degli studenti nel database. Il nome "canonico" √® quello pi√π lungo e pi√π frequente negli abbinamenti.
            </p>

            {% if name_groups %}
            <div class="space-y-4 mb-6">
                {% for group in name_groups %}
                <div class="border-l-4 border-yellow-500 bg-yellow-50 p-4 rounded">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="font-semibold text-sm text-gray-700 mb-2">Varianti trovate:</div>
                            <div class="space-y-1">
                                {% for variant in group.variants %}
                                <div class="flex items-center gap-2">
                                    {% if variant == group.canonical %}
                                    <span class="px-2 py-1 bg-green-500 text-white text-xs rounded font-semibold">
                                        {{ variant }} ‚úì CANONICO
                                    </span>
                                    {% else %}
                                    <span class="px-2 py-1 bg-gray-200 text-gray-700 text-xs rounded">
                                        {{ variant }}
                                    </span>
                                    <span class="text-xs text-gray-500">
                                        ({{ group.frequencies[variant] }} abbinamenti)
                                    </span>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div>
                            <div class="font-semibold text-sm text-gray-700 mb-2">Conversioni:</div>
                            <div class="space-y-1 text-xs text-gray-600">
                                {% for variant in group.variants %}
                                {% if variant != group.canonical %}
                                <div>{{ variant }} ‚Üí <span class="font-semibold text-green-600">{{ group.canonical }}</span></div>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <button onclick="normalizeNames()"
                    id="normalize-btn"
                    class="w-full px-6 py-3 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 text-lg">
                ‚úì Esegui Normalizzazione Database
            </button>

            <div id="normalize-result" class="mt-4 hidden"></div>

            {% else %}
            <div class="p-4 bg-green-50 border border-green-200 rounded">
                <p class="text-green-700">‚úÖ Tutti i nomi sono gi√† uniformi! Nessuna variante trovata.</p>
            </div>
            {% endif %}
        </div>

        <!-- Sezione 2: Gestione Associazioni Pagante‚ÜíStudente -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">üîó Gestione Associazioni Pagante‚ÜíStudente</h2>
            <p class="text-sm text-gray-600 mb-4">
                Crea o modifica associazioni tra nomi paganti (da SMS) e nomi studenti (da calendario).
            </p>

            <!-- Form per nuova associazione -->
            <div class="border rounded-lg p-4 mb-4">
                <h3 class="font-semibold text-lg mb-3">‚ûï Nuova Associazione</h3>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome Pagante (da SMS)</label>
                        <input type="text" id="new-pagante" placeholder="es. Sergey"
                               class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome Studente (da calendario)</label>
                        <input type="text" id="new-studente" placeholder="es. Sergey"
                               class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="flex items-end">
                        <button onclick="addAssociation()"
                                class="w-full px-4 py-2 bg-blue-600 text-white rounded font-semibold hover:bg-blue-700">
                            ‚úì Aggiungi
                        </button>
                    </div>
                </div>
            </div>

            <!-- Lista associazioni esistenti -->
            <div id="associations-list" class="space-y-2">
                <h3 class="font-semibold text-lg mb-3">üìã Associazioni Esistenti</h3>
                <div class="text-sm text-gray-500">Caricamento...</div>
            </div>

            <div id="association-result" class="mt-4 hidden"></div>
        </div>

        <!-- Sezione 3: Aggiornamento Google Calendar -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold mb-4">üìÖ Aggiornamento Google Calendar</h2>
            <p class="text-sm text-gray-600 mb-4">
                Aggiorna gli eventi su Google Calendar: normalizza i nomi, aggiungi nota "PAGATO" e cambia colore a blu per le lezioni completamente pagate.
            </p>

            <!-- Statistiche -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="p-4 bg-blue-50 rounded">
                    <div class="text-sm text-gray-600">Lezioni totali in calendario</div>
                    <div class="text-3xl font-bold text-blue-600">{{ total_lessons_count }}</div>
                </div>
                <div class="p-4 bg-green-50 rounded">
                    <div class="text-sm text-gray-600">Lezioni completamente pagate</div>
                    <div class="text-3xl font-bold text-green-600">{{ paid_lessons_count }}</div>
                </div>
            </div>

            <!-- Info operazioni -->
            <div class="mb-6 p-4 bg-blue-50 rounded border border-blue-200">
                <div class="text-sm font-semibold text-blue-800 mb-2">üîÑ Operazioni che verranno eseguite:</div>
                <ul class="text-xs text-gray-700 space-y-1">
                    <li>‚Ä¢ <strong>Normalizzazione titoli:</strong> Aggiorna i titoli degli eventi con i nomi corretti dal database</li>
                    <li>‚Ä¢ <strong>Colore blu:</strong> Cambia il colore degli eventi a blu (Blueberry) per le lezioni pagate</li>
                    <li>‚Ä¢ <strong>‚ö° Modalit√† incrementale:</strong> Aggiorna SOLO le lezioni modificate dall'ultimo sync</li>
                </ul>
            </div>

            <!-- Pulsanti aggiornamento -->
            <div class="grid grid-cols-2 gap-4">
                <button onclick="updateCalendar()"
                        id="calendar-btn"
                        class="px-6 py-3 bg-purple-600 text-white rounded-lg font-bold hover:bg-purple-700 text-lg">
                    ‚ö° Sync Incrementale
                </button>
                <button onclick="forceFullUpdate()"
                        id="full-update-btn"
                        class="px-6 py-3 bg-orange-600 text-white rounded-lg font-bold hover:bg-orange-700 text-lg">
                    üîÑ Sync Completo
                </button>
            </div>

            <div class="mt-2 text-xs text-gray-500 text-center">
                <strong>‚ö° Incrementale:</strong> veloce, solo modifiche recenti ‚Ä¢
                <strong>üîÑ Completo:</strong> lento, tutti gli eventi
            </div>

            <div id="calendar-result" class="mt-4 hidden"></div>
        </div>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-lg p-8 shadow-2xl text-center max-w-md">
                <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto mb-4"></div>
                <p class="text-xl font-bold text-gray-700" id="loading-text">Elaborazione in corso...</p>
                <p class="text-sm text-gray-500 mt-2">Attendi, potrebbe richiedere alcuni minuti</p>
            </div>
        </div>
    </div>

    <script>
        // Carica associazioni all'avvio
        document.addEventListener('DOMContentLoaded', function() {
            loadAssociations();
        });

        function loadAssociations() {
            fetch('/api/get_associations')
                .then(response => response.json())
                .then(data => {
                    const listDiv = document.getElementById('associations-list');
                    listDiv.innerHTML = '<h3 class="font-semibold text-lg mb-3">üìã Associazioni Esistenti</h3>';

                    if (data.associations && data.associations.length > 0) {
                        data.associations.forEach(assoc => {
                            const item = document.createElement('div');
                            item.className = 'flex items-center justify-between p-3 bg-gray-50 rounded border';
                            item.innerHTML = `
                                <div class="flex items-center gap-4">
                                    <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded font-semibold">${assoc.nome_studente}</span>
                                    <span class="text-gray-400">‚Üê</span>
                                    <span class="px-3 py-1 bg-green-100 text-green-800 rounded">${assoc.nome_pagante}</span>
                                    ${assoc.note ? `<span class="text-xs text-gray-500">${assoc.note}</span>` : ''}
                                </div>
                                <button onclick="deleteAssociation(${assoc.id_assoc})"
                                        class="px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600">
                                    üóëÔ∏è Elimina
                                </button>
                            `;
                            listDiv.appendChild(item);
                        });
                    } else {
                        listDiv.innerHTML += '<div class="text-sm text-gray-500">Nessuna associazione trovata.</div>';
                    }
                })
                .catch(error => {
                    console.error('Errore caricamento associazioni:', error);
                });
        }

        function addAssociation() {
            const pagante = document.getElementById('new-pagante').value.trim();
            const studente = document.getElementById('new-studente').value.trim();

            if (!pagante || !studente) {
                alert('Inserisci sia il nome pagante che il nome studente');
                return;
            }

            fetch('/api/add_association', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    nome_pagante: pagante,
                    nome_studente: studente
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showResult('association-result', true, `Associazione ${studente} ‚Üê ${pagante} aggiunta!`);
                    // Pulisci form
                    document.getElementById('new-pagante').value = '';
                    document.getElementById('new-studente').value = '';
                    // Ricarica lista
                    loadAssociations();
                } else {
                    showResult('association-result', false, `Errore: ${data.error}`);
                }
            })
            .catch(error => {
                showResult('association-result', false, `Errore di connessione: ${error}`);
            });
        }

        function deleteAssociation(id) {
            if (!confirm('Confermi l\'eliminazione di questa associazione?')) {
                return;
            }

            fetch(`/api/delete_association/${id}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showResult('association-result', true, 'Associazione eliminata!');
                    loadAssociations();
                } else {
                    showResult('association-result', false, `Errore: ${data.error}`);
                }
            })
            .catch(error => {
                showResult('association-result', false, `Errore di connessione: ${error}`);
            });
        }

        function showLoading(text) {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        function showResult(elementId, success, message) {
            const resultDiv = document.getElementById(elementId);
            resultDiv.classList.remove('hidden');

            if (success) {
                resultDiv.className = 'mt-4 p-4 bg-green-50 border border-green-200 rounded';
                resultDiv.innerHTML = `<p class="text-green-700 font-semibold">‚úÖ ${message}</p>`;
            } else {
                resultDiv.className = 'mt-4 p-4 bg-red-50 border border-red-200 rounded';
                resultDiv.innerHTML = `<p class="text-red-700 font-semibold">‚ùå ${message}</p>`;
            }
        }

        function normalizeNames() {
            if (!confirm('Confermi la normalizzazione dei nomi nel database?')) {
                return;
            }

            showLoading('Normalizzazione nomi in corso...');

            // Prepara lista cambiamenti
            const changes = [];
            {% for group in name_groups %}
            {% for variant in group.variants %}
            {% if variant != group.canonical %}
            changes.push({
                old: '{{ variant }}',
                new: '{{ group.canonical }}'
            });
            {% endif %}
            {% endfor %}
            {% endfor %}

            fetch('/api/normalize_names', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ changes: changes })
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    showResult('normalize-result', true,
                        `Normalizzazione completata! ${data.updated} record aggiornati.`);

                    // Ricarica pagina dopo 2 secondi
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    showResult('normalize-result', false,
                        `Errore: ${data.error}`);
                }
            })
            .catch(error => {
                hideLoading();
                showResult('normalize-result', false,
                    `Errore di connessione: ${error}`);
            });
        }

        function updateCalendar() {
            if (!confirm('Confermi il SYNC INCREMENTALE? Verranno aggiornate solo le lezioni modificate di recente.')) {
                return;
            }

            showLoading('Sync incrementale Google Calendar...');
            document.getElementById('calendar-btn').disabled = true;

            fetch('/api/update_calendar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                document.getElementById('calendar-btn').disabled = false;

                if (data.success) {
                    showResult('calendar-result', true,
                        data.message + (data.output ? `<pre class="mt-2 text-xs bg-white p-2 rounded overflow-auto max-h-64">${data.output}</pre>` : ''));
                } else {
                    showResult('calendar-result', false,
                        `Errore: ${data.error}`);
                }
            })
            .catch(error => {
                hideLoading();
                document.getElementById('calendar-btn').disabled = false;
                showResult('calendar-result', false,
                    `Errore di connessione: ${error}`);
            });
        }

        function forceFullUpdate() {
            if (!confirm('Confermi il SYNC COMPLETO? Verranno ri-processati TUTTI gli eventi (pi√π lento). Usalo solo se necessario.')) {
                return;
            }

            showLoading('Sync completo Google Calendar (tutti gli eventi)...');
            document.getElementById('full-update-btn').disabled = true;

            fetch('/api/force_full_calendar_update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                document.getElementById('full-update-btn').disabled = false;

                if (data.success) {
                    showResult('calendar-result', true,
                        data.message + (data.output ? `<pre class="mt-2 text-xs bg-white p-2 rounded overflow-auto max-h-64">${data.output}</pre>` : ''));
                } else {
                    showResult('calendar-result', false,
                        `Errore: ${data.error}`);
                }
            })
            .catch(error => {
                hideLoading();
                document.getElementById('full-update-btn').disabled = false;
                showResult('calendar-result', false,
                    `Errore di connessione: ${error}`);
            });
        }
    </script>
</body>
</html>
